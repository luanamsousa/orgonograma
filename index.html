<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Exportar PDF - Organograma</title>

<style>
  body{
    margin:0;
    padding:30px;
    font-family: Arial, sans-serif;
    background:#fff;
    color:#0b2b45;
  }
  h1{
    text-align:center;
    margin:0 0 20px 0;
    font-size:22px;
  }
  .sub{
    text-align:center;
    margin:0 0 22px 0;
    color:#555;
    font-weight:bold;
  }

  .funcao{
    border:1px solid #e6e8ee;
    border-radius:12px;
    padding:14px 16px;
    margin-bottom:14px;
  }
  .funcao-titulo{
    font-size:16px;
    font-weight:bold;
    color:#0b5ed7;
    margin-bottom:10px;
    border-left:6px solid #0dcaf0;
    padding-left:10px;
  }
  .pessoas{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
  }
  .pessoa{
    background:#e7f8fd;
    border:1px solid #bfeef7;
    color:#053b4c;
    padding:7px 10px;
    border-radius:18px;
    font-weight:bold;
    font-size:12px;
    white-space:nowrap;
  }
  .vazio{
    color:#777;
    font-style:italic;
    font-weight:bold;
  }

  /* Impressão */
  @media print{
    body{ padding:18px; }
    .funcao{ page-break-inside: avoid; }
  }
</style>
</head>

<body>
  <h1>Organograma Funcional</h1>
  <div class="sub" id="subtitulo">Carregando…</div>
  <div id="conteudo"></div>

<script>
  // MESMA URL DO SEU WEB APP
  const BASE =
    "https://script.google.com/macros/s/AKfycbzfYOs-nwQrn28CKY_OR4FiXMb2SfF5skBHRsu_w_eNFxIHMBCofehTRPppUqf7pli3IQ/exec";

  const DATA_URL = BASE + "?mode=data&callback=cb&_=" + Date.now();

  function norm(t){
    return String(t||"")
      .trim()
      .toUpperCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "");
  }

  function getParam(name){
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }

  function cb(payload){
    const subtitulo = document.getElementById("subtitulo");
    const container = document.getElementById("conteudo");

    if(!payload || payload.error){
      subtitulo.textContent = "Erro ao carregar dados";
      container.innerHTML = `<div class="vazio">Não foi possível gerar o PDF.</div>`;
      return;
    }

    const filtroPostoRaw = getParam("posto"); // vem do index: export.html?posto=...
    const filtroPosto = filtroPostoRaw ? norm(decodeURIComponent(filtroPostoRaw)) : "TODOS";

    let people = payload.people || [];
    let hierarchy = payload.hierarchy || [];

    if (filtroPosto !== "TODOS"){
      people = people.filter(p => norm(p.posto) === filtroPosto);
      subtitulo.textContent = `Filtro: ${filtroPosto}`;
    } else {
      subtitulo.textContent = `Todos os postos`;
    }

    // Agrupa por posto
    const peopleByPosto = new Map();
    people.forEach(p=>{
      const key = norm(p.posto);
      if(!key) return;
      if(!peopleByPosto.has(key)) peopleByPosto.set(key, []);
      peopleByPosto.get(key).push({ ...p, _nomeKey: norm(p.nome) });
    });

    // Ordena nomes
    for (const [k, arr] of peopleByPosto.entries()){
      arr.sort((a,b)=>a._nomeKey.localeCompare(b._nomeKey));
    }

    // Postos a renderizar: usa hierarchy (ordem) ou fallback (postoss encontrados)
    const postosDaHierarquia = (hierarchy || [])
      .map(h => norm(h.func)) // aqui "func" é o posto
      .filter(Boolean);

    const postosFallback = Array.from(peopleByPosto.keys()).sort();
    const postosParaRender = postosDaHierarquia.length ? postosDaHierarquia : postosFallback;

    container.innerHTML = "";

    if (!postosParaRender.length){
      container.innerHTML = `<div class="vazio">Nenhum dado para exibir.</div>`;
      // Mesmo assim imprime (vai sair só título)
      setTimeout(()=>window.print(), 300);
      return;
    }

    postosParaRender.forEach(postoKey=>{
      // Se está filtrado por um posto, só renderiza ele
      if (filtroPosto !== "TODOS" && postoKey !== filtroPosto) return;

      const pessoas = peopleByPosto.get(postoKey) || [];

      const bloco = document.createElement("div");
      bloco.className = "funcao";

      const titulo = document.createElement("div");
      titulo.className = "funcao-titulo";
      titulo.textContent = `POSTO/GRADUAÇÃO: ${postoKey} (${pessoas.length})`;

      const pessoasDiv = document.createElement("div");
      pessoasDiv.className = "pessoas";

      if (!pessoas.length){
        const vazio = document.createElement("div");
        vazio.className = "vazio";
        vazio.textContent = "Sem pessoas cadastradas";
        pessoasDiv.appendChild(vazio);
      } else {
        pessoas.forEach(p=>{
          const tag = document.createElement("div");
          tag.className = "pessoa";
          tag.textContent = `${p.posto} - ${p.nome}`;
          pessoasDiv.appendChild(tag);
        });
      }

      bloco.appendChild(titulo);
      bloco.appendChild(pessoasDiv);
      container.appendChild(bloco);
    });

    // MUITO IMPORTANTE: esperar renderizar antes de imprimir
    setTimeout(() => window.print(), 600);
  }

  // Carrega JSONP
  const s = document.createElement("script");
  s.src = DATA_URL;
  s.onerror = () => {
    document.getElementById("subtitulo").textContent = "Erro ao carregar script de dados";
    document.getElementById("conteudo").innerHTML = `<div class="vazio">Não foi possível gerar o PDF.</div>`;
  };
  document.head.appendChild(s);
</script>
</body>
</html>
