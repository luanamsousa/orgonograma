<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Organograma Funcional – Exportação</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body {
    margin: 0;
    padding: 25px;
    font-family: Arial, sans-serif;
    background: #ffffff;
  }

  h1 {
    text-align: center;
    color: #0b2b45;
    margin-bottom: 5px;
  }

  .subtitulo {
    text-align: center;
    font-size: 13px;
    color: #555;
    margin-bottom: 25px;
  }

  .acoes {
    text-align: center;
    margin-bottom: 25px;
  }

  button {
    background: #0b5ed7;
    color: #fff;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
  }

  /* ===== AGRUPAMENTO POR NÍVEL ===== */

  .nivel {
    margin-bottom: 35px;
  }

  .nivel-titulo {
    font-weight: bold;
    color: #0b5ed7;
    margin-bottom: 12px;
    border-bottom: 2px solid #0b5ed7;
    padding-bottom: 5px;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 18px;
  }

  .funcao {
    border: 2px solid #0b5ed7;
    border-radius: 12px;
    padding: 10px;
    background: #f0f6ff;
    min-height: 90px;
  }

  .funcao-titulo {
    text-align: center;
    font-weight: bold;
    font-size: 13px;
    margin-bottom: 8px;
    color: #0b2b45;
  }

  .pessoas {
    display: flex;
    flex-direction: column;
    gap: 4px;
    font-size: 11px;
  }

  .pessoa {
    background: #ffffff;
    border-radius: 6px;
    padding: 4px 6px;
    border: 1px solid #0dcaf0;
  }

  .vazio {
    font-style: italic;
    color: #888;
    text-align: center;
    font-size: 11px;
  }

  .rodape {
    margin-top: 30px;
    font-size: 11px;
    text-align: right;
    color: #666;
  }

  /* ===== IMPRESSÃO ===== */
  @media print {
    .acoes {
      display: none;
    }

    @page {
      size: A4 landscape;
      margin: 15mm;
    }
  }
</style>
</head>

<body>

<h1>Organograma Funcional</h1>
<div class="subtitulo">Estrutura Hierárquica Institucional</div>

<div class="acoes">
  <button onclick="window.print()">Exportar para PDF</button>
</div>

<div id="organograma"></div>

<div class="rodape" id="dataGeracao"></div>

<script>
const BASE =
  "https://script.google.com/macros/s/AKfycbyigyFcP5TxvuawbFkbdc7H2PyRhITazUHLMn2vcaWyea5wL6b5RXnFlWQC1F-bTnBVbg/exec";

const params = new URLSearchParams(window.location.search);
const POSTO_FILTRO = params.get("posto") || "TODOS";

const DATA_URL = BASE + "?mode=data&callback=cb&_=" + Date.now();

function cb(payload) {
  montar(payload.hierarchy, payload.people);
  gerarData();
}

function montar(hierarchy, people) {
  const container = document.getElementById("organograma");
  container.innerHTML = "";

  // Separação simples por níveis
  const oficiais = ["CEL","TCEL","MAJ","CAP","1º TEN","2º TEN"];
  const pracas = ["ASP","ST","1º SGT","2º SGT","3º SGT","CB","SD"];

  criarNivel("OFICIAIS", oficiais, hierarchy, people, container);
  criarNivel("PRAÇAS", pracas, hierarchy, people, container);
}

function criarNivel(titulo, listaPostos, hierarchy, people, container) {
  const nivelDiv = document.createElement("div");
  nivelDiv.className = "nivel";

  const tituloDiv = document.createElement("div");
  tituloDiv.className = "nivel-titulo";
  tituloDiv.textContent = titulo;

  const grid = document.createElement("div");
  grid.className = "grid";

  hierarchy.forEach(h => {
    if (!listaPostos.includes(h.func)) return;

    let pessoasFunc = people.filter(p => p.func === h.func);

    if (POSTO_FILTRO !== "TODOS") {
      pessoasFunc = pessoasFunc.filter(p => p.posto === POSTO_FILTRO);
    }

    const bloco = document.createElement("div");
    bloco.className = "funcao";

    const funcTitulo = document.createElement("div");
    funcTitulo.className = "funcao-titulo";
    funcTitulo.textContent = h.func;

    const pessoasDiv = document.createElement("div");
    pessoasDiv.className = "pessoas";

    if (pessoasFunc.length === 0) {
      const vazio = document.createElement("div");
      vazio.className = "vazio";
      vazio.textContent = "Sem pessoas";
      pessoasDiv.appendChild(vazio);
    } else {
      pessoasFunc.forEach(p => {
        const card = document.createElement("div");
        card.className = "pessoa";
        card.textContent = `${p.posto} - ${p.nome}`;
        pessoasDiv.appendChild(card);
      });
    }

    bloco.appendChild(funcTitulo);
    bloco.appendChild(pessoasDiv);
    grid.appendChild(bloco);
  });

  nivelDiv.appendChild(tituloDiv);
  nivelDiv.appendChild(grid);
  container.appendChild(nivelDiv);
}

function gerarData() {
  const agora = new Date();
  document.getElementById("dataGeracao").textContent =
    "Gerado em: " + agora.toLocaleString("pt-BR");
}

const s = document.createElement("script");
s.src = DATA_URL;
document.head.appendChild(s);
</script>

</body>
</html>
