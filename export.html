<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Organograma Funcional — Exportação</title>

  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    :root{
      --azul:#0b5ed7;
      --azul-claro:#0dcaf0;
      --fundo:#ffffff;
      --card:#eef6ff;
      --borda:#77a8ff;
      --texto:#0b2b45;
      --sombra: 0 10px 24px rgba(0,0,0,.10);
    }

    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: var(--fundo);
      color: var(--texto);
    }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 28px 18px 40px;
      text-align:center;
    }

    h1{
      margin: 0 0 6px;
      font-size: 34px;
      font-weight: 900;
      letter-spacing: .2px;
    }

    .sub{
      margin: 0 0 18px;
      font-weight: 700;
      color: #2b3d55;
      opacity: .9;
    }

    .actions{
      display:flex;
      justify-content:center;
      gap:12px;
      margin: 14px 0 20px;
      flex-wrap: wrap;
    }

    .btn{
      border:0;
      background: var(--azul);
      color:#fff;
      font-weight:900;
      padding: 12px 18px;
      border-radius: 12px;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(11,94,215,.20);
    }
    .btn:hover{ filter: brightness(.96); }

    .status{
      margin: 10px 0 18px;
      font-weight: 800;
    }
    .status.ok{ color:#0a7a3d; }
    .status.err{ color:#c91c1c; }

    /* Centraliza o organograma */
    #chartWrap{
      display:flex;
      justify-content:center;
      overflow: visible;
    }

    #chart{
      overflow: visible;
      padding: 10px 0;
    }

    /* Ajustes nos nós do OrgChart */
    .google-visualization-orgchart-node{
      border: none !important;
      background: transparent !important;
    }

    /* Caixa padrão */
    .box{
      width: 320px;
      background: var(--card);
      border: 2px solid var(--borda);
      border-radius: 14px;
      padding: 14px 14px 12px;
      box-shadow: var(--sombra);
      text-align:center;
    }

    .box .tag{
      display:inline-block;
      background: rgba(11,94,215,.10);
      color: var(--azul);
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      letter-spacing: .5px;
      margin-bottom: 10px;
    }

    .box .func{
      font-size: 22px;
      font-weight: 900;
      color: #0a2f5a;
      margin: 0 0 8px;
      text-transform: uppercase;
    }

    .box .meta{
      font-size: 13px;
      font-weight: 800;
      opacity: .85;
    }

    .box .meta small{
      display:block;
      margin-top: 4px;
      opacity: .85;
      font-style: italic;
      font-weight: 800;
    }

    /* Linhas do chart */
    .google-visualization-orgchart-lineleft,
    .google-visualization-orgchart-lineright,
    .google-visualization-orgchart-linebottom{
      border-color: #7aa7d6 !important;
    }

    /* PRINT */
    @media print {
      body { background: #fff; }
      .actions, .status { display: none !important; }
      .wrap{ max-width: none; padding: 0; }
      #chartWrap{ justify-content:center; }
      /* Evita cortar caixas */
      #chart { zoom: 0.9; }
      @page { margin: 12mm; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Organograma Funcional</h1>
    <div class="sub" id="subTitle">Exportação</div>

    <div class="status" id="status">Carregando…</div>

    <div class="actions">
      <button class="btn" onclick="window.print()">Exportar para PDF</button>
    </div>

    <div id="chartWrap">
      <div id="chart"></div>
    </div>
  </div>

  <script>
    /* ============================
      1) CONFIG
    ============================ */

    // ✅ COLOQUE A SUA URL DO WEB APP AQUI (sem parâmetros)
    const BASE = "https://script.google.com/macros/s/AKfycbzfYOs-nwQrn28CKY_OR4FiXMb2SfF5skBHRsu_w_eNFxIHMBCofehTRPppUqf7pli3IQ/exec";

    const params = new URLSearchParams(location.search);
    const filtroPosto = (params.get("posto") || "TODOS").trim();

    document.getElementById("subTitle").textContent =
      (filtroPosto === "TODOS")
        ? "Exportação (Todos os postos)"
        : "Exportação (Filtro: " + filtroPosto + ")";

    function setStatusOk(msg){
      const el = document.getElementById("status");
      el.className = "status ok";
      el.textContent = "✓ " + msg;
    }
    function setStatusErr(msg){
      const el = document.getElementById("status");
      el.className = "status err";
      el.textContent = "✕ " + msg;
    }

    /* ============================
      2) GOOGLE CHARTS
    ============================ */
    google.charts.load("current", { packages: ["orgchart"] });

    /* ============================
      3) JSONP: callback que o Apps Script chama
    ============================ */
    window.cb = function(payload){
      try{
        if(!payload || payload.error){
          setStatusErr(payload?.error || "Erro ao carregar dados.");
          return;
        }

        // Filtra pessoas pelo POSTO/GRADUAÇÃO quando vier ?posto=
        let people = Array.isArray(payload.people) ? payload.people : [];
        if(filtroPosto !== "TODOS"){
          people = people.filter(p => (p.posto || "").trim().toUpperCase() === filtroPosto.toUpperCase());
        }

        // Hierarquia sempre completa (todas as funções)
        const hierarchy = Array.isArray(payload.hierarchy) ? payload.hierarchy : [];

        google.charts.setOnLoadCallback(function(){
          drawOrg(hierarchy, people);
          setStatusOk("Organograma pronto para exportação");
        });

      }catch(err){
        console.error(err);
        setStatusErr("Falha ao processar dados.");
      }
    };

    /* ============================
      4) DESENHAR ORGANOGRAMA
    ============================ */
    function esc(s){
      return String(s || "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;");
    }

    function funcNodeHtml(func, count){
      const vazio = (count === 0);
      return `
        <div class="box">
          <div class="tag">FUNÇÃO</div>
          <div class="func">${esc(func)}</div>
          <div class="meta">
            ${count} pessoa(s)
            ${vazio ? `<small>Sem pessoas cadastradas</small>` : ``}
          </div>
        </div>
      `;
    }

    function drawOrg(hierarchy, people){
      // Mapa função -> pessoas
      const map = new Map();
      for(const p of people){
        const f = (p.func || "").trim();
        if(!f) continue;
        if(!map.has(f)) map.set(f, []);
        map.get(f).push(p);
      }

      // Prepara DataTable
      const data = new google.visualization.DataTable();
      data.addColumn("string","Name");
      data.addColumn("string","Manager");
      data.addColumn("string","ToolTip");

      // 1) Nós das funções (hierarquia)
      //    Cria ID estável pra cada função
      const funcId = (f) => "FUNC__" + String(f||"").trim();

      const rows = [];

      // garante ordem da planilha (respeita o que você montou em HIERARQUIA_FUNCOES)
      for(const h of hierarchy){
        const func = (h.func || "").trim();
        const sup  = (h.sup  || "").trim();
        if(!func) continue;

        const count = (map.get(func) || []).length;

        rows.push([
          { v: funcId(func), f: funcNodeHtml(func, count) },
          sup ? funcId(sup) : "",
          func
        ]);
      }

      data.addRows(rows);

      const chart = new google.visualization.OrgChart(document.getElementById("chart"));
      chart.draw(data, { allowHtml:true });
    }

    /* ============================
      5) INJETAR SCRIPT JSONP (CORRETO)
    ============================ */
    (function loadData(){
      const url = BASE + "?mode=data&callback=cb&_=" + Date.now();
      const s = document.createElement("script");
      s.src = url;

      s.onerror = () => {
        // Esse é o erro que você estava vendo
        setStatusErr("Erro ao carregar o Web App (Apps Script). Verifique a URL BASE e se o deploy está ativo.");
      };

      document.head.appendChild(s);
    })();
  </script>
</body>
</html>
